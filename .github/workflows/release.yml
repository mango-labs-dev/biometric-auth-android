name: Release on merge

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read current version
        id: version
        run: |
          CURRENT=$(grep '^LIB_VERSION=' gradle.properties | cut -d'=' -f2)
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "Current version: $CURRENT"

      - name: Get merged PR label
        id: label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGE_MSG=$(git log -1 --pretty=%s)
          PR_NUMBER=$(echo "$MERGE_MSG" | grep -oE '#[0-9]+' | head -1 | tr -d '#')

          BUMP="patch"
          if [ -n "$PR_NUMBER" ]; then
            LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')
            if echo "$LABELS" | grep -qx 'major'; then
              BUMP="major"
            elif echo "$LABELS" | grep -qx 'minor'; then
              BUMP="minor"
            fi
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Bump type: $BUMP"

      - name: Bump version
        id: bump
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ steps.version.outputs.current }}"

          case "${{ steps.label.outputs.bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "New version: $NEW_VERSION"

          sed -i "s/^LIB_VERSION=.*/LIB_VERSION=$NEW_VERSION/" gradle.properties

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Run tests
        run: ./gradlew test

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: ./gradlew publishReleasePublicationToGitHubPackagesRepository

      - name: Commit version bump and tag
        env:
          NEW_VERSION: ${{ steps.bump.outputs.new }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add gradle.properties
          git commit -m "chore: bump version to $NEW_VERSION"
          git tag "v$NEW_VERSION"
          git push origin main --tags
